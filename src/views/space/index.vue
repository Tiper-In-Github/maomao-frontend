<template>
  <mmCard v-if="userInfo" title="个人空间" style="margin-bottom: 10px;">
    <p><el-icon><User /></el-icon> {{ userInfo.name }}</p>
    <p><svg t="1697734215269" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5547" width="15" height="15"><path d="M95.55512889 807.27608889A66.48263111 66.48263111 0 0 1 75.09333333 758.63381333c0-18.78698667 6.84487111-34.95253333 20.46179556-48.64227555L710.06435555 95.48231111A66.48263111 66.48263111 0 0 1 758.63381333 75.09333333c18.78698667 0 34.95253333 6.84487111 48.64227556 20.46179556l121.16878222 121.16878222c13.61692445 13.68974222 20.46179555 29.85528889 20.46179556 48.64227556 0 18.78698667-6.84487111 34.95253333-20.46179556 48.64227555L313.93564445 928.51768889a66.48263111 66.48263111 0 0 1-48.64227556 20.46179556 66.48263111 66.48263111 0 0 1-48.64227556-20.46179556l-121.16878222-121.16878222zM568.28814222 353.25724445l-406.17756444 406.17756444 102.45461333 102.45461333 406.17756444-406.17756444L568.28814222 353.25724445z m191.14666667-191.14666667L626.32391111 295.22147555l102.45461334 102.45461334 133.11089777-133.11089778-102.45461333-102.45461333z m-447.10115556-20.38897778c1.09226667-3.49525333 3.93216-5.17006222 8.51968-5.17006222 4.51470222 0 7.42741333 1.67480889 8.51968 5.09724444l20.46179556 40.99640889 44.41884444 6.77205334c4.51470222 0 7.35459555 2.03889778 8.51968 5.97105777 1.16508445 4.00497778 0 7.71868445-3.42243555 11.14112l-32.40391111 30.72910223 8.51968 44.34602666c0 4.51470222-1.45635555 8.00995555-4.29624889 10.19448889-2.83989333 2.33016889-6.5536 2.33016889-11.06830223 0l-39.24878222-20.38897778-39.3216 20.38897778c-4.51470222 2.33016889-8.15559111 2.33016889-10.99548444 0-2.91271111-2.18453333-4.29624889-5.67978667-4.29624889-10.19448889l8.51968-44.41884444-32.40391111-30.65628445c-3.42243555-3.42243555-4.58752-7.13614222-3.42243556-11.14112 1.16508445-3.93216 4.00497778-5.97105778 8.51968-5.97105777l44.41884445-6.77205334 20.38897777-40.99640889z m167.26243556-34.22435555c1.09226667-3.42243555 2.83989333-5.09724445 5.09724444-5.09724445 2.25735111 0 4.00497778 1.67480889 5.09724445 5.09724445l13.68974222 25.63185777 30.72910222 5.09724445c2.18453333 0 3.93216 1.45635555 5.09724445 4.29624888 1.16508445 2.83989333 0.58254222 4.80597333-1.67480889 5.97105778l-22.20942223 22.13660445 5.09724445 29.05429333c1.16508445 3.42243555 0.58254222 5.67978667-1.67480889 6.84487111a7.28177778 7.28177778 0 0 1-6.84487111 0l-27.30666667-13.68974222-27.30666666 13.68974222a7.28177778 7.28177778 0 0 1-6.84487112 0c-2.25735111-1.16508445-2.83989333-3.42243555-1.67480888-6.84487111l5.09724444-28.98147556-22.20942222-22.20942222c-2.18453333-1.16508445-2.83989333-3.13116445-1.67480889-5.97105778 1.16508445-2.91271111 2.91271111-4.29624889 5.09724445-4.29624888l30.72910222-5.09724445 13.68974222-25.63185777z m-327.68 0c1.09226667-3.42243555 2.83989333-5.09724445 5.09724444-5.09724445 2.25735111 0 4.00497778 1.67480889 5.09724445 5.09724445l13.68974222 25.63185777 30.72910222 5.09724445c2.18453333 0 3.93216 1.45635555 5.09724445 4.29624888 1.16508445 2.83989333 0.58254222 4.80597333-1.67480889 5.97105778l-22.20942223 22.13660445 5.09724445 29.05429333c1.16508445 3.42243555 0.58254222 5.67978667-1.67480889 6.84487111a7.28177778 7.28177778 0 0 1-6.84487111 0l-27.30666667-13.68974222-27.30666666 13.68974222a7.28177778 7.28177778 0 0 1-6.84487112 0c-2.25735111-1.16508445-2.83989333-3.42243555-1.67480888-6.84487111l5.09724444-28.98147556-22.20942222-22.20942222c-2.18453333-1.16508445-2.83989333-3.13116445-1.67480889-5.97105778 1.16508445-2.91271111 2.91271111-4.29624889 5.09724445-4.29624888l30.72910222-5.09724445 13.68974222-25.63185777z m709.97333333 380.61852444c1.09226667-2.25735111 2.83989333-3.42243555 5.09724445-3.42243556 2.25735111 0 4.00497778 1.16508445 5.09724444 3.42243556l13.68974222 27.30666666 30.72910222 3.42243556c2.18453333 1.09226667 3.93216 2.83989333 5.09724445 5.09724444 1.16508445 2.25735111 0.58254222 4.58752-1.67480889 6.84487112l-22.20942222 20.46179555 5.09724444 30.72910223c1.16508445 2.25735111 0.58254222 4.29624889-1.67480888 5.97105777-2.33016889 1.67480889-4.58752 1.96608-6.84487112 0.87381333l-27.30666666-15.3645511-27.30666667 15.29173333c-2.25735111 1.16508445-4.58752 0.87381333-6.84487111-0.80099556s-2.83989333-3.64088889-1.67480889-5.97105777l5.09724445-30.72910223-22.20942223-20.46179555c-2.18453333-2.25735111-2.83989333-4.58752-1.67480889-6.84487112a11.14112 11.14112 0 0 1 5.09724445-5.09724444l30.72910222-3.42243556 13.68974222-27.30666666z" p-id="5548" fill="#303133"></path></svg> {{ userInfo.experience }} 点经验</p>
    <p><el-icon><Clock /></el-icon> {{ formatTimestamp(userInfo.registration_time) }}</p>
  </mmCard>
  <VideoGrid :videos="videos" :hasMore="hasMoreVideos" @load-more="loadMore"/>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useStore } from 'vuex';
import { useRoute } from 'vue-router';
import axios from 'axios';
import mmCard from '@/components/rzm/mmCard.vue';
import useFormat from "@/composables/useFormat";
import VideoGrid from '@/components/video/VideoGrid.vue';

const store = useStore();
const route = useRoute();
const apiUrl = ref(store.state.apiUrl);
const { formatTimestamp } = useFormat();

const userInfo = ref(null);
const hasMoreVideos = ref(true);
const videos = ref([]);
const currentAid = ref(1);
let isLoading = false;
const isAllDataLoaded = ref(false);

onMounted(async () => {
  try {
    // 获取用户信息
    const userResponse = await axios.get(`${apiUrl.value}/api/space/${route.params.uid}`);
    userInfo.value = userResponse.data;

  } catch (error) {
    console.error("获取数据错误:", error);
  }
});

async function loadMore() {
  if (isLoading || isAllDataLoaded.value) return;

  isLoading = true;

  try {
    const response = await axios.get(`${apiUrl.value}/api/space/videos/${route.params.uid}`, {
      params: { start: currentAid.value, count: 10 }
    });
    if (response.data.hasMore === false) {
      hasMoreVideos.value = false;
    }
    videos.value.push(...response.data.data);
    if (response.data.length < 10) {
      isAllDataLoaded.value = true;
    } else {
      currentAid.value += 10;
    }
  } catch (error) {
    console.error("获取视频错误:", error);
  } finally {
    isLoading = false;
  }
}

loadMore();

</script>
